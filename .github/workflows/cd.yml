name: CD - Deploy to Production

on:
    workflow_dispatch:

    workflow_run:
        workflows: ["CI - Build & Push Images"]
        types:
            - completed

env:
    REGISTRY: ghcr.io
    IMAGE_NAMESPACE: ${{ github.repository }}

jobs:
    deploy:
        name: Deploy to Server
        runs-on: ubuntu-latest

        if: ${{ github.event.workflow_run.conclusion == 'success' }}

        steps:
            # ================= CHECKOUT =================
            - name: Checkout
              uses: actions/checkout@v4

            # ================= SET IMAGE TAG =================
            - name: Set Image Version
              id: vars
              run: |
                  echo "BACKEND_IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/demo-backend:latest" >> $GITHUB_ENV
                  echo "FRONTEND_IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/demo-frontend:latest" >> $GITHUB_ENV

            # ================= SSH DEPLOY =================
            - name: Deploy via SSH
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.SERVER_IP }}
                  username: ${{ secrets.USER }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  script: |

                      set -e

                      echo "üöÄ Start Deploy..."

                      cd /home/deploy/app


                      # ================= LOGIN GHCR =================
                      echo "${{ secrets.TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin


                      # ================= EXPORT IMAGE =================
                      export BACKEND_IMAGE=${{ env.BACKEND_IMAGE }}
                      export FRONTEND_IMAGE=${{ env.FRONTEND_IMAGE }}


                      # ================= PULL NEW IMAGE =================
                      echo "üì¶ Pull new images..."
                      docker pull $BACKEND_IMAGE
                      docker pull $FRONTEND_IMAGE


                      # ================= DB MIGRATION (PRISMA) =================
                      echo "üóÑÔ∏è Running Prisma migrate..."

                      docker compose run --rm backend \
                        npx prisma migrate deploy


                      # ================= RESTART SERVICE =================
                      echo "üîÑ Restart services..."

                      docker compose down

                      docker compose up -d


                      # ================= CLEAN =================
                      echo "üßπ Cleanup old images..."
                      docker image prune -f


                      echo "‚úÖ Deploy completed!"
