name: CD - Deploy to Production

on:
    workflow_dispatch:

    workflow_run:
        workflows: ["CI - Build & Push Images"]
        types:
            - completed
        branches:
            - main

env:
    REGISTRY: ghcr.io

jobs:
    deploy:
        name: Deploy to Server
        runs-on: ubuntu-latest

        # Ch·ªâ ch·∫°y khi CI success
        if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

        steps:
            # ================= CHECKOUT =================
            - name: Checkout
              uses: actions/checkout@v4

            # ================= SET IMAGE NAMESPACE (LOWERCASE) =================
            - name: Set image namespace (lowercase)
              run: |
                  echo "IMAGE_NAMESPACE=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV
                  echo "BACKEND_IMAGE=${{ env.REGISTRY }}/${GITHUB_REPOSITORY,,}/demo-backend:latest" >> $GITHUB_ENV
                  echo "FRONTEND_IMAGE=${{ env.REGISTRY }}/${GITHUB_REPOSITORY,,}/demo-frontend:latest" >> $GITHUB_ENV
            # ================= COPY DOCKER-COMPOSE.YML TO VM =================
            - name: Copy docker-compose.yml to VM
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.SERVER_IP }}
                  username: ${{ secrets.USER }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  source: "docker-compose.yml"
                  target: "/home/deploy/app/"
                  overwrite: true

            # ================= SSH DEPLOY =================
            - name: Deploy via SSH
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.SERVER_IP }}
                  username: ${{ secrets.USER }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  script: |
                      set -e

                      echo "üöÄ Start Deploy..."
                      cd /home/deploy/app

                      # ================= LOGIN GHCR =================
                      echo "${{ secrets.TOKEN }}" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin

                      # ================= EXPORT IMAGE =================
                      export BACKEND_IMAGE=${{ env.BACKEND_IMAGE }}
                      export FRONTEND_IMAGE=${{ env.FRONTEND_IMAGE }}

                      # ================= PULL NEW IMAGE =================
                      echo "üì¶ Pull new images..."
                      docker pull $BACKEND_IMAGE
                      docker pull $FRONTEND_IMAGE

                      # ================= DB MIGRATION (PRISMA) =================
                      echo "üóÑÔ∏è Running Prisma migrate..."
                      docker compose run --rm backend npx prisma db push

                      # ================= RESTART SERVICE =================
                      echo "üîÑ Restart services..."
                      docker compose down
                      docker compose up -d

                      # ================= CLEAN =================
                      echo "üßπ Cleanup old images..."
                      docker image prune -f

                      echo "‚úÖ Deploy completed!"
